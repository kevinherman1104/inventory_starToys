<!DOCTYPE html>
<html lang="en">
{% extends "base.html" %}
{% block content %}
<head>
  <meta charset="UTF-8">
  <title>Create Invoice</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container-fluid py-4">

<div class="row">
  <!-- LEFT: Product list -->
  <div class="col-md-7">
    <h2>Products</h2>
    <input type="text" id="search" placeholder="Search products..." class="form-control mb-3">

    <table class="table table-bordered">
      <thead>
      <tr>
        <th>Product ID</th>
        <th>Name</th>
        <th>Stock</th>
        <th>Selling Price</th>
        <th>Image</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody id="table-body">
      {% for row in rows %}
        <tr>
          <td>{{ row.product_id }}</td>
          <td>{{ row.name }}</td>
          <td>{{ row.stock }}</td>
          <td>{{ row.selling_price }}</td>
          <td>
            {% if row.image_url %}
              <img src="{{ row.image_url }}"
                   alt="Preview" width="50"
                   style="cursor:pointer"
                   data-bs-toggle="modal"
                   data-bs-target="#imgModal{{ row.id }}">
              <div class="modal fade" id="imgModal{{ row.id }}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <img src="{{ row.image_url }}" class="img-fluid rounded">
                  </div>
                </div>
              </div>
            {% else %}
              No Image
            {% endif %}
          </td>
          <td>
            <button class="btn btn-success btn-sm add-btn"
                    data-id="{{ row.id }}"
                    data-name="{{ row.name }}"
                    data-price="{{ row.selling_price }}"
                    data-image="{{ row.image_url|default('', true) }}">
              Add
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- RIGHT: Invoice builder -->
  <div class="col-md-5">
    <h2>Create Invoice</h2>
    <form id="invoiceForm">
      <input type="text" name="customer_name" class="form-control mb-2" placeholder="Customer Name">

      <table class="table table-bordered">
        <thead>
        <tr>
          <th>Image</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="invoice-items"></tbody>
      </table>

      <h4>Total: <span id="total">0</span></h4>
      <button type="button" class="btn btn-primary" onclick="saveInvoice()">Save Invoice</button>
    </form>
  </div>
</div>

<script>
// ✅ Live search (AJAX)
document.getElementById("search").addEventListener("input", async function () {
  const q = this.value.trim();
  const res = await fetch(`/invoice?q=${encodeURIComponent(q)}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
  const rows = await res.json();

  const tbody = document.getElementById("table-body");
  tbody.innerHTML = "";

  for (const row of rows) {
    const imgTag = row.image_url
      ? `<img src="${row.image_url}" alt="Preview" width="50" class="img-thumbnail" style="cursor:pointer">`
      : "No Image";

    tbody.innerHTML += `
      <tr>
        <td>${row.product_id}</td>
        <td>${row.name}</td>
        <td>${row.stock}</td>
        <td>${row.selling_price}</td>
        <td>${imgTag}</td>
        <td>
          <button class="btn btn-success btn-sm add-btn"
                  data-id="${row.id}"
                  data-name="${row.name}"
                  data-price="${row.selling_price}"
                  data-image="${row.image_url || ''}">
            Add
          </button>
        </td>
      </tr>`;
  }

  attachAddButtons(); // rebind after update
});

// ✅ Add Product to Invoice Table
function addToInvoice(row) {
  const tbody = document.getElementById("invoice-items");
  const existingRow = Array.from(tbody.querySelectorAll("tr")).find(tr =>
    tr.dataset.productId === String(row.id)
  );

  if (existingRow) {
    const qtyInput = existingRow.querySelector(".qty");
    qtyInput.value = parseInt(qtyInput.value) + 1;
    const price = parseFloat(existingRow.querySelector(".price").innerText);
    existingRow.querySelector(".subtotal").innerText =
      (qtyInput.value * price).toFixed(2);
    updateTotal();
    return;
  }

  const tr = document.createElement("tr");
  tr.dataset.productId = row.id;

  const imgTag = row.image_url
    ? `<img src="${row.image_url}" alt="Preview" width="50" style="cursor:pointer">`
    : "No Image";

  tr.innerHTML = `
    <td>${imgTag}</td>
    <td>${row.name}</td>
    <td><input type="number" value="1" min="1" class="form-control qty" style="width:80px"></td>
    <td class="price">${row.selling_price}</td>
    <td class="subtotal">${row.selling_price}</td>
    <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateTotal()">X</button></td>
  `;

  tbody.appendChild(tr);
  updateTotal();

  tr.querySelector(".qty").addEventListener("input", function () {
    const qty = parseInt(this.value) || 0;
    const price = parseFloat(row.selling_price);
    tr.querySelector(".subtotal").innerText = (qty * price).toFixed(2);
    updateTotal();
  });
}

// ✅ Bind "Add" buttons dynamically
function attachAddButtons() {
  document.querySelectorAll(".add-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const row = {
        id: this.dataset.id,
        name: this.dataset.name,
        selling_price: parseFloat(this.dataset.price),
        image_url: this.dataset.image
      };
      addToInvoice(row);
    });
  });
}

// ✅ Update total
function updateTotal() {
  let total = 0;
  document.querySelectorAll("#invoice-items .subtotal").forEach(el => {
    total += parseFloat(el.innerText) || 0;
  });
  document.getElementById("total").innerText = total.toFixed(2);
}

// ✅ Save invoice
function saveInvoice() {
  const customerInput = document.querySelector("[name='customer_name']");
  const customerName = customerInput.value.trim();
  if (!customerName) {
    alert("⚠️ Please enter a customer name before saving the invoice.");
    customerInput.focus();
    return;
  }

  const invoiceRows = document.querySelectorAll("#invoice-items tr");
  if (!invoiceRows.length) {
    alert("⚠️ Please add at least one product before saving the invoice.");
    return;
  }

  const items = [];
  invoiceRows.forEach(tr => {
    const productId = tr.dataset.productId;
    const name = tr.children[1].innerText;
    const qty = parseInt(tr.querySelector(".qty").value) || 0;
    const price = parseFloat(tr.children[3].innerText) || 0;
    const img = tr.children[0].querySelector("img");
    const image_url = img ? img.src.replace("/static/", "") : null;
    items.push({ id: productId, name, qty, price, image_url });
  });

  fetch("/save_invoice", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ customer_name: customerName, items })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) return alert("❌ " + data.error);
    alert("✅ Invoice saved! ID: " + data.invoice_id);
    document.getElementById("invoiceForm").reset();
    document.getElementById("invoice-items").innerHTML = "";
    document.getElementById("total").innerText = "0";
    document.getElementById("search").dispatchEvent(new Event("input"));
  })
  .catch(err => {
    console.error("Error:", err);
    alert("❌ Failed to save invoice.");
  });
}

// Prevent ENTER from submitting form
document.getElementById("invoiceForm").addEventListener("keydown", e => {
  if (e.key === "Enter") e.preventDefault();
});

// Initial binding
attachAddButtons();
</script>
</body>
{% endblock %}
</html>
