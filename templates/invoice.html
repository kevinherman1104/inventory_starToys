<!DOCTYPE html>
<html>
        {% extends "base.html" %}
{% block content %}
<head>
    <title>Invoices</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
<div class="container-fluid">
    <div class="row">
        <!-- Left side: Product list -->
        <div class="col-md-7">
            <h2>Products</h2>
            <input type="text" id="search" placeholder="Search products..." class="form-control mb-3">

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Product ID</th>
                        <th>Name</th>
                        <th>Stock</th>
                        <th>Selling Price</th>
                        <th>Image</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for row in rows %}
                    <tr>
                        <td>{{ row.product_id }}</td>
                        <td>{{ row.name }}</td>
                        <td>{{ row.stock }}</td>
                        <td>{{ row.selling_price }}</td>
                        <td>
                            {% if row.image_url %}
                            <img src="{{ row.image_url }}" alt="Preview" width="50"
                                 style="cursor:pointer"
                                 data-bs-toggle="modal"
                                 data-bs-target="#imgModal{{ row.id }}">
                            <!-- Modal -->
                            <div class="modal fade" id="imgModal{{ row.id }}" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <img src="{{ row.image_url }}" class="img-fluid rounded">
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                        <button class="btn btn-success btn-sm add-btn" data-row='{{ row|tojson|safe }}'>
                            Add
                        </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Right side: Invoice builder -->
        <div class="col-md-5">
            <h2>Create Invoice</h2>
            <form id="invoiceForm">
                <input type="text" name="customer_name" class="form-control mb-2" placeholder="Customer Name">

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>

                <h4>Total: <span id="total">0</span></h4>
                <button type="button" class="btn btn-primary" onclick="saveInvoice()">Save Invoice</button>
            </form>
        </div>
    </div>
</div>

<script>
// Add product to invoice table
function addToInvoice(row) {
    const tbody = document.getElementById("invoice-items");
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td>${row.name}</td>
        <td><input type="number" value="1" min="1" class="form-control qty" style="width:80px"></td>
        <td>${row.selling_price}</td>
        <td class="subtotal">${row.selling_price}</td>
        <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateTotal()">X</button></td>
    `;

    tbody.appendChild(tr);
    updateTotal();

    // attach event to recalc on qty change
    tr.querySelector(".qty").addEventListener("input", function() {
        const qty = parseInt(this.value) || 0;
        const price = row.selling_price;
        tr.querySelector(".subtotal").innerText = qty * price;
        updateTotal();
    });
}

// Recalculate total
function updateTotal() {
    let total = 0;
    document.querySelectorAll("#invoice-items .subtotal").forEach(el => {
        total += parseFloat(el.innerText) || 0;
    });
    document.getElementById("total").innerText = total.toFixed(2);
}

// Save invoice (AJAX POST)
function saveInvoice() {
    const customerName = document.querySelector("[name='customer_name']").value || "Walk-in";
    const items = [];

    document.querySelectorAll("#invoice-items tr").forEach(tr => {
        const name = tr.children[0].innerText;
        const qty = parseInt(tr.querySelector(".qty").value) || 0;
        const price = parseFloat(tr.children[2].innerText) || 0;
        items.push({ name, qty, price });
    });

    fetch("/save_invoice", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ customer_name: customerName, items: items })
    })
    .then(res => res.json())
    .then(data => {
        alert("Invoice saved! ID: " + data.invoice_id);
        document.getElementById("invoiceForm").reset();
        document.getElementById("invoice-items").innerHTML = "";
        document.getElementById("total").innerText = "0";
    });
}
document.querySelectorAll(".add-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const row = JSON.parse(this.dataset.row);
        addToInvoice(row);
    });
});
</script>
</body>
{% endblock %}

</html>
