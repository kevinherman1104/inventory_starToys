<!DOCTYPE html>
<html lang="id">
{% extends "base.html" %}
{% block content %}
<head>
  <meta charset="UTF-8">
  <title>Buat Nota</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* Make Buat Nota table flexible and proportional */
  #invoice-table {
    table-layout: auto !important; /* let columns size dynamically */
    width: 100%;
  }

  /* widen specific columns */
  #invoice-table th:nth-child(2),
  #invoice-table td:nth-child(2) {
    width: 40%; /* Produk column wider */
  }

  #invoice-table th:nth-child(4),
  #invoice-table td:nth-child(4),
  #invoice-table th:nth-child(5),
  #invoice-table td:nth-child(5) {
    width: 15%; /* Harga & Subtotal columns wider */
  }

  /* make sure qty and aksi remain compact */
  #invoice-table th:nth-child(3),
  #invoice-table td:nth-child(3),
  #invoice-table th:nth-child(6),
  #invoice-table td:nth-child(6) {
    width: 8%;
    white-space: nowrap;
  }

  /* keep cell content tidy */
  #invoice-table td, #invoice-table th {
    vertical-align: middle;
  }

  #invoice-table .price, #invoice-table .subtotal {
    text-align: right;
    white-space: nowrap;
  }
</style>

</head>

<body class="py-4">
  <div class="container">
    <div class="row g-4">
      <!-- LEFT: Produk list -->
      <div class="col-lg-7 col-md-12">
        <h2>Daftar Produk</h2>
        <input type="text" id="search" placeholder="Cari produk..." class="form-control mb-3">

        <table class="table table-bordered align-middle table-striped">
          <thead class="table-light">
            <tr>  
              <th>Produk ID</th>
              <th>Nama</th>
              <th>Stok</th>
              <th>Harga Jual</th>
              <th>Gambar</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="table-body">
            {% for row in rows %}
            <tr>
              <td>{{ row.product_id }}</td>
              <td>{{ row.name }}</td>
              <td>{{ row.stock }}</td>
              <td>{{ "Rp {:,.0f}".format(row.selling_price) }}</td>
              <td>
                {% if row.image_url %}
                  <img src="{{ row.image_url }}" alt="Preview" width="50"
                       style="cursor:pointer" data-bs-toggle="modal"
                       data-bs-target="#imgModal{{ row.id }}">
                  <div class="modal fade" id="imgModal{{ row.id }}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <img src="{{ row.image_url }}" class="img-fluid rounded">
                      </div>
                    </div>
                  </div>
                {% else %}
                  Tidak Ada Gambar
                {% endif %}
              </td>
              <td>
                <button class="btn btn-success btn-sm add-btn"
                        data-id="{{ row.id }}"
                        data-name="{{ row.name }}"
                        data-price="{{ row.selling_price }}"
                        data-image="{{ row.image_url or '' }}">
                  Tambah
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- RIGHT: Nota builder -->
      <div class="col-lg-5 col-md-12">
        <h2>Buat Nota</h2>
        <form id="invoiceForm">
          <input type="text" name="customer_name" class="form-control mb-2" placeholder="Nama Pelanggan">

          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center w-100" id="invoice-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 10%;">Gambar</th>
                  <th style="width: 30%;">Produk</th>
                  <th style="width: 6%;">Qty</th>
                  <th style="width: 18%;">Harga</th>
                  <th style="width: 18%;">Subtotal</th>
                  <th style="width: 8%;">Aksi</th>
                </tr>
              </thead>
              <tbody id="invoice-items"></tbody>
            </table>
          </div>

          <div class="text-end mt-3">
            <h4>Total: <span id="total">Rp 0</span></h4>
          </div>
          <button type="button" class="btn btn-primary mt-2" onclick="saveInvoice()">Simpan Nota</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Image Preview Modal -->
<div class="modal fade" id="imgPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-transparent border-0 text-center">
      <img id="previewImage" src="" class="img-fluid rounded shadow">
    </div>
  </div>
</div>


<script>
// ✅ Format number → Rupiah
function formatRupiah(num) {
  const n = parseFloat(num);
  if (isNaN(n)) return "Rp 0";
  return "Rp " + n.toLocaleString("id-ID");
}

// ✅ Parse Rupiah → number
function parseRupiah(str) {
  if (!str) return 0;
  return parseFloat(String(str).replace(/[^\d]/g, "")) || 0;
}

// ✅ Live Search (AJAX)
document.getElementById("search").addEventListener("input", async function () {
  const q = this.value.trim();
  const res = await fetch(`/invoice?q=${encodeURIComponent(q)}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
  const rows = await res.json();

  const tbody = document.getElementById("table-body");
  tbody.innerHTML = "";

  for (const row of rows) {
    const imgTag = row.image_url
      ? `<img src="${row.image_url}" alt="Preview" width="50" class="img-thumbnail" style="cursor:pointer">`
      : "Tidak Ada Gambar";

    const price = parseFloat(row.selling_price) || 0;

    tbody.innerHTML += `
      <tr>
        <td>${row.product_id}</td>
        <td>${row.name}</td>
        <td>${row.stock}</td>
        <td>${formatRupiah(price)}</td>
        <td>${imgTag}</td>
        <td>
          <button class="btn btn-success btn-sm add-btn"
                  data-id="${row.id}"
                  data-name="${row.name}"
                  data-price="${price}"
                  data-image="${row.image_url || ''}">
            Tambah
          </button>
        </td>
      </tr>`;
  }

  attachAddButtons();
});

// ✅ Add product to invoice
function addToInvoice(row) {
  const tbody = document.getElementById("invoice-items");

  let price = parseFloat(row.selling_price) || 0;

  const existingRow = Array.from(tbody.querySelectorAll("tr")).find(
    tr => tr.dataset.productId === String(row.id)
  );

  if (existingRow) {
    const qtyInput = existingRow.querySelector(".qty");
    qtyInput.value = parseInt(qtyInput.value) + 1;
    const subtotal = parseInt(qtyInput.value) * price;
    existingRow.querySelector(".subtotal").dataset.subtotal = subtotal;
    existingRow.querySelector(".subtotal").innerText = formatRupiah(subtotal);
    updateTotal();
    return;
  }

  const tr = document.createElement("tr");
  tr.dataset.productId = row.id;

  const imgTag = row.image_url
    ? `<img src="${row.image_url}" alt="Preview" width="50" 
             class="img-thumbnail"
             style="cursor:pointer"
             onclick="showImage('${row.image_url}')">`
    : "Tidak Ada Gambar";

  tr.innerHTML = `
    <td>${imgTag}</td>
    <td>${row.name}</td>
    <td><input type="number" value="1" min="1" class="form-control qty" style="width:80px"></td>
    <td class="price" data-price="${price}">${formatRupiah(price)}</td>
    <td class="subtotal" data-subtotal="${price}">${formatRupiah(price)}</td>
    <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateTotal()">X</button></td>
  `;

  tbody.appendChild(tr);
  updateTotal();

  tr.querySelector(".qty").addEventListener("input", function () {
    const qty = parseInt(this.value) || 0;
    const subtotal = qty * price;
    tr.querySelector(".subtotal").dataset.subtotal = subtotal;
    tr.querySelector(".subtotal").innerText = formatRupiah(subtotal);
    updateTotal();
  });
}


// ✅ Attach Add buttons
function attachAddButtons() {
  document.querySelectorAll(".add-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const row = {
        id: this.dataset.id,
        name: this.dataset.name,
        selling_price: parseFloat(this.dataset.price) || 0,
        image_url: this.dataset.image
      };
      addToInvoice(row);
    });
  });
}

// ✅ Update total
function updateTotal() {
  let total = 0;
  document.querySelectorAll("#invoice-items .subtotal").forEach(el => {
    total += parseFloat(el.dataset.subtotal) || 0;
  });
  document.getElementById("total").innerText = formatRupiah(total);
}

// ✅ Save invoice
function saveInvoice() {
  const customerInput = document.querySelector("[name='customer_name']");
  const customerName = customerInput.value.trim();
  if (!customerName) {
    alert("⚠️ Harap masukkan nama pelanggan sebelum menyimpan nota.");
    customerInput.focus();
    return;
  }

  const invoiceRows = document.querySelectorAll("#invoice-items tr");
  if (!invoiceRows.length) {
    alert("⚠️ Harap tambahkan minimal satu produk sebelum menyimpan nota.");
    return;
  }

  const items = [];
  invoiceRows.forEach(tr => {
    const productId = tr.dataset.productId;
    const name = tr.children[1].innerText;
    const qty = parseInt(tr.querySelector(".qty").value) || 0;
    const price = parseFloat(tr.querySelector(".price").dataset.price) || 0;
    const img = tr.children[0].querySelector("img");
    const image_url = img ? img.src.replace("/static/", "") : null;
    items.push({ id: productId, name, qty, price, image_url });
  });

  fetch("/save_invoice", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ customer_name: customerName, items })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert("❌ " + data.error);
      alert("✅ Nota berhasil disimpan! ID: " + data.invoice_id);
      document.getElementById("invoiceForm").reset();
      document.getElementById("invoice-items").innerHTML = "";
      document.getElementById("total").innerText = "Rp 0";
      document.getElementById("search").dispatchEvent(new Event("input"));
    })
    .catch(err => {
      console.error("Error:", err);
      alert("❌ Gagal menyimpan nota.");
    });
}

// ✅ Prevent ENTER key
document.getElementById("invoiceForm").addEventListener("keydown", e => {
  if (e.key === "Enter") e.preventDefault();
});

attachAddButtons();

function showImage(src) {
  const modalImg = document.getElementById("previewImage");
  modalImg.src = src;
  new bootstrap.Modal(document.getElementById("imgPreviewModal")).show();
}

</script>
</body>
{% endblock %}
</html>
