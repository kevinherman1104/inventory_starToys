{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2>Edit Invoice #{{ invoice.id }}</h2>

  <form id="editInvoiceForm" method="POST">
    <div class="mb-3">
      <label>Customer Names</label>
      <input type="text" class="form-control" name="customer_name" value="{{ invoice.customer_name }}">
    </div>

    <h5>Items</h5>
    <table class="table table-bordered align-middle" id="invoiceItemsTable">
      <thead>
        <tr>
          <th>Image</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr data-item-id="{{ item.id }}">
          <td>
            {% if item.image_url %}
              <img src="{{ item.image_url }}" class="img-thumbnail" style="max-width:50px; cursor:pointer;" 
                   onclick="showImage('{{ item.image_url }}')">
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ item.name }}</td>
          <td>
            <input type="hidden" name="item_id" value="{{ item.id }}">
            <input type="number" name="quantity" class="form-control qty" value="{{ item.quantity }}" min="1">
          </td>
          <td>
            <input type="number" name="price" class="form-control price" value="{{ item.price }}" step="0.01">
          </td>
          <td class="subtotal">{{ "%.2f"|format(item.subtotal) }}</td>
          <td>
            <button type="button" class="btn btn-sm btn-danger remove-item-btn">üóëÔ∏è Remove</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-3">
      <strong>Total: $<span id="invoiceTotal">0.00</span></strong>
    </div>

    <div class="mt-4">
      <button type="submit" class="btn btn-success">üíæ Save Changes</button>
      <a href="{{ url_for('invoice_detail', invoice_id=invoice.id) }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- Image modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <img id="modalImage" src="" class="img-fluid rounded">
    </div>
  </div>
</div>

<script>
function showImage(src) {
  document.getElementById("modalImage").src = src;
  new bootstrap.Modal(document.getElementById("imageModal")).show();
}

// Remove item visually (mark row for deletion)
document.querySelectorAll('.remove-item-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    const row = this.closest('tr');
    row.remove();
    updateTotal();
    if (document.querySelectorAll('#invoiceItemsTable tbody tr').length === 0) {
      if (confirm("This invoice has no more items. Do you want to delete the entire invoice?")) {
        fetch(`/invoice/{{ invoice.id }}/delete`, { method: "POST" })
          .then(r => r.json())
          .then(data => {
            alert(data.message || "Invoice deleted.");
            window.location.href = "{{ url_for('invoices') }}";
          })
          .catch(err => alert("Error deleting invoice: " + err));
      }
    }
  });
});

// Update total when quantity/price changes
function updateTotal() {
  let total = 0;
  document.querySelectorAll('#invoiceItemsTable tbody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.qty')?.value || 0);
    const price = parseFloat(row.querySelector('.price')?.value || 0);
    const subtotal = qty * price;
    row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
    total += subtotal;
  });
  document.getElementById('invoiceTotal').textContent = total.toFixed(2);
}

document.querySelectorAll('.qty, .price').forEach(el => el.addEventListener('input', updateTotal));
updateTotal();
</script>
{% endblock %}
